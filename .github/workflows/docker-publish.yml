name: Publicar Imagen de Docker en Docker Hub

# Este flujo de trabajo se ejecuta cada vez que hay un push a la rama 'main'
on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    # Usamos la √∫ltima versi√≥n de Ubuntu para ejecutar nuestro trabajo
    runs-on: ubuntu-latest

    steps:
      # 1. Obtenemos el c√≥digo del repositorio
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4

      # 2. Iniciamos sesi√≥n en Docker Hub
      - name: Iniciar sesi√≥n en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 3. Construimos la imagen y la publicamos
      # Agregar m√∫ltiples tags incluyendo latest
      - name: Construir y publicar la imagen de Docker
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/python_deployment_automate:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/python_deployment_automate:v${{ github.run_number }}
      # Disparar el deploy hook de Render despu√©s de subir la imagen
      - name: Disparar deployment en Render
        if: success()
        run: |
          curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}"
        continue-on-error: true  # No fallar si el webhook falla

      # Notificaci√≥n del resultado
      - name: Notificar resultado del deployment
        if: always()
        run: |
          echo "‚úÖ Imagen Docker publicada exitosamente"
          echo "üöÄ Deploy hook disparado en Render"